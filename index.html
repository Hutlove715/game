<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
        }

        .game-container {
            display: flex;
            gap: 20px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            margin: 0 auto;
        }

        .game-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .game-sidebar {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #555;
            width: 100%;
        }

        .score-item {
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        .game-main {
            position: relative;
        }

        #gameCanvas {
            border: 3px solid #333;
            border-radius: 10px;
            background: #1a1a1a;
            display: block;
            margin: 0 auto;
            position: relative;
            width: 400px;
            height: 400px;
            box-sizing: border-box;
        }

        .controls {
            margin-top: 20px;
            color: #666;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            display: none;
        }

        .game-over.show {
            display: block;
        }

        .game-over h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .game-over button {
            padding: 15px 30px;
            font-size: 1.2em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
        }

        .game-over button:hover {
            background: #764ba2;
        }

        .game-over button.secondary {
            background: #6c757d;
        }

        .game-over button.secondary:hover {
            background: #5a6268;
        }

        .game-over .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .difficulty-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .difficulty-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .difficulty-btn {
            padding: 10px 20px;
            font-size: 1em;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn:hover {
            background: #667eea;
            color: white;
        }

        .difficulty-btn.active {
            background: #667eea;
            color: white;
        }

        .rank-display {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            width: 100%;
            text-align: center;
        }

        .rank-info {
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .rank-points {
            margin-top: 5px;
            font-size: 0.85em;
        }

        .rank-progress {
            margin-top: 10px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .rank-progress-bar {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }

        .game-over .rank-change {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .rank-up {
            color: #4CAF50;
            font-weight: bold;
        }

        .rank-down {
            color: #f44336;
            font-weight: bold;
        }

        .clear-data-btn {
            margin-top: 0;
            padding: 8px 16px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 80px;
        }

        .clear-data-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .clear-data-btn:active {
            transform: scale(0.95);
        }

        .rank-help-btn {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            vertical-align: middle;
            transition: all 0.3s;
        }

        .rank-help-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .rank-help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .rank-help-modal.show {
            display: flex;
        }

        .rank-help-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .rank-help-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rank-help-close:hover {
            background: #e0e0e0;
        }

        .rank-help-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .rank-help-section {
            margin-bottom: 25px;
        }

        .rank-help-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .rank-help-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .rank-help-section ul {
            color: #666;
            line-height: 1.8;
            padding-left: 20px;
        }

        .rank-help-section li {
            margin-bottom: 5px;
        }

        .rank-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .rank-table th,
        .rank-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .rank-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        .rank-table tr:hover {
            background: #f9f9f9;
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 400px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .pause-overlay {
                width: min(400px, 100vw - 40px);
                height: min(400px, 100vw - 40px);
            }
        }

        .pause-text {
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        .virtual-controls {
            display: none;
            margin-top: 20px;
            user-select: none;
        }

        .virtual-controls.show {
            display: block;
        }

        .virtual-controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            justify-content: center;
            margin: 0 auto;
        }

        .virtual-btn {
            width: 60px;
            height: 60px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .virtual-btn:active {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }

        .virtual-btn.empty {
            border: none;
            background: transparent;
            cursor: default;
        }

        .virtual-btn.empty:active {
            transform: none;
        }

        @media (max-width: 768px) {
            .virtual-controls {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                padding: 20px;
            }

            .game-sidebar {
                min-width: auto;
                width: 100%;
            }

            .difficulty-buttons {
                flex-direction: row;
                justify-content: center;
            }

            #gameCanvas {
                width: min(400px, 100vw - 40px) !important;
                height: min(400px, 100vw - 40px) !important;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-sidebar">
            <h1 style="text-align: center; color: #333; margin-bottom: 20px; font-size: 2em;">ğŸ è´ªåƒè›‡æ¸¸æˆ</h1>
            
            <div class="difficulty-selector">
                <p style="margin-bottom: 10px; color: #666; font-weight: bold;">é€‰æ‹©éš¾åº¦ï¼š</p>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" data-difficulty="easy">ç®€å•</button>
                    <button class="difficulty-btn active" data-difficulty="normal">æ™®é€š</button>
                    <button class="difficulty-btn" data-difficulty="hard">å›°éš¾</button>
                </div>
            </div>

            <div class="score-board" style="margin-top: 20px;">
                <div class="score-item">å¾—åˆ†: <span id="score">0</span></div>
                <div class="score-item">æœ€é«˜åˆ†: <span id="highScore">0</span></div>
            </div>
        </div>

        <div class="game-main">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div class="controls">
                <p>ä½¿ç”¨æ–¹å‘é”®æˆ– WASD æ§åˆ¶è›‡çš„ç§»åŠ¨ | ç©ºæ ¼é”®æš‚åœ</p>
                <p style="margin-top: 5px; font-size: 0.9em; color: #888;">å½“å‰éš¾åº¦: <span id="currentDifficultyDisplay">æ™®é€š</span></p>
            </div>
            
            <!-- æš‚åœæç¤º -->
            <div id="pauseOverlay" class="pause-overlay" style="display: none;">
                <div class="pause-text">â¸ï¸ æ¸¸æˆå·²æš‚åœ<br>æŒ‰ç©ºæ ¼é”®ç»§ç»­</div>
            </div>

            <!-- è™šæ‹Ÿæ–¹å‘é”®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
            <div class="virtual-controls" id="virtualControls">
                <div class="virtual-controls-grid">
                    <div class="virtual-btn empty"></div>
                    <div class="virtual-btn" data-direction="up">â†‘</div>
                    <div class="virtual-btn empty"></div>
                    <div class="virtual-btn" data-direction="left">â†</div>
                    <div class="virtual-btn empty"></div>
                    <div class="virtual-btn" data-direction="right">â†’</div>
                    <div class="virtual-btn empty"></div>
                    <div class="virtual-btn" data-direction="down">â†“</div>
                    <div class="virtual-btn empty"></div>
                </div>
            </div>

            <div class="rank-display">
                <div>å½“å‰æ®µä½: <span id="currentRank" style="font-size: 1.2em;">é’é“œ5</span>
                    <span class="rank-help-btn" id="rankHelpBtn" title="æŸ¥çœ‹æ®µä½è§„åˆ™">?</span>
                </div>
                <div class="rank-info">
                    <div class="rank-points">æ®µä½åˆ†: <span id="rankPoints">0</span></div>
                    <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.8;" id="rankHint"></div>
                    <div class="rank-progress">
                        <div class="rank-progress-bar" id="rankProgress" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="clear-data-btn" id="clearDataBtn">æ¸…é™¤æ•°æ®</button>
                        <button class="clear-data-btn" id="exportDataBtn" style="background: rgba(76, 175, 80, 0.3);">å¯¼å‡ºæ•°æ®</button>
                        <button class="clear-data-btn" id="importDataBtn" style="background: rgba(33, 150, 243, 0.3);">å¯¼å…¥æ•°æ®</button>
                    </div>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- æ®µä½è§„åˆ™è¯´æ˜å¼¹çª— -->
    <div class="rank-help-modal" id="rankHelpModal">
        <div class="rank-help-content">
            <button class="rank-help-close" onclick="closeRankHelp()">Ã—</button>
            <h2>ğŸ“Š æ®µä½ç³»ç»Ÿè¯´æ˜</h2>
            
            <div class="rank-help-section">
                <h3>æ®µä½ç»„æˆ</h3>
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>æ®µä½</th>
                            <th>æ®µä½åˆ†èŒƒå›´</th>
                            <th>å°æ®µ/æ˜Ÿæ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>é’é“œ</td>
                            <td>0-100åˆ†</td>
                            <td>5ä¸ªå°æ®µï¼ˆ5â†’1ï¼‰</td>
                        </tr>
                        <tr>
                            <td>ç™½é“¶</td>
                            <td>101-300åˆ†</td>
                            <td>5ä¸ªå°æ®µï¼ˆ5â†’1ï¼‰</td>
                        </tr>
                        <tr>
                            <td>é»„é‡‘</td>
                            <td>301-500åˆ†</td>
                            <td>5ä¸ªå°æ®µï¼ˆ5â†’1ï¼‰</td>
                        </tr>
                        <tr>
                            <td>é“‚é‡‘</td>
                            <td>501-800åˆ†</td>
                            <td>5ä¸ªå°æ®µï¼ˆ5â†’1ï¼‰</td>
                        </tr>
                        <tr>
                            <td>é’»çŸ³</td>
                            <td>801-1200åˆ†</td>
                            <td>5ä¸ªå°æ®µï¼ˆ5â†’1ï¼‰</td>
                        </tr>
                        <tr>
                            <td>ç‹è€…</td>
                            <td>1201åˆ†ä»¥ä¸Š</td>
                            <td>æ¯50åˆ†ä¸€é¢—æ˜Ÿ</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="rank-help-section">
                <h3>æ’ä½åŠ åˆ†è§„åˆ™</h3>
                <p><strong>åŸºç¡€è§„åˆ™ï¼š</strong></p>
                <ul>
                    <li>å¾—åˆ†è¶Šå¤šï¼ŒåŠ åˆ†è¶Šé«˜ï¼šæ®µä½åˆ† = æ¸¸æˆå¾—åˆ† Ã— éš¾åº¦å€ç‡ Ã— 0.15</li>
                    <li>å•å±€åŠ åˆ†ä¸Šé™ï¼š50åˆ†</li>
                    <li>æœ€ä½åŠ åˆ†ï¼šè‡³å°‘1åˆ†</li>
                </ul>
                
                <p><strong>éš¾åº¦å€ç‡ï¼š</strong></p>
                <ul>
                    <li>ç®€å•æ¨¡å¼ï¼š0.5å€</li>
                    <li>æ™®é€šæ¨¡å¼ï¼š1.0å€</li>
                    <li>å›°éš¾æ¨¡å¼ï¼š1.5å€</li>
                </ul>

                <p><strong>æœ€ä½åˆ†æ•°è¦æ±‚ï¼š</strong></p>
                <ul>
                    <li>ç®€å•æ¨¡å¼ï¼šè‡³å°‘20åˆ†æ‰èƒ½è·å¾—æ®µä½åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                    <li>æ™®é€šæ¨¡å¼ï¼šè‡³å°‘30åˆ†æ‰èƒ½è·å¾—æ®µä½åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                    <li>å›°éš¾æ¨¡å¼ï¼šè‡³å°‘40åˆ†æ‰èƒ½è·å¾—æ®µä½åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                </ul>
            </div>

            <div class="rank-help-section">
                <h3>æ‰£åˆ†æœºåˆ¶</h3>
                <p><strong>æœªè¾¾åˆ°æœ€ä½åˆ†æ•°è¦æ±‚ï¼š</strong>æ ¹æ®å¾—åˆ†æ‰£åˆ†ï¼Œæœ€å¤šæ‰£100åˆ†æ®µä½åˆ†</p>
                <ul>
                    <li>ç®€å•æ¨¡å¼ï¼šè‡³å°‘20åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                    <li>æ™®é€šæ¨¡å¼ï¼šè‡³å°‘30åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                    <li>å›°éš¾æ¨¡å¼ï¼šè‡³å°‘40åˆ†ï¼Œæœªè¾¾åˆ°ä¼šæ‰£åˆ†</li>
                </ul>
                
                <p><strong>é»„é‡‘ä»¥ä¸Šæ®µä½ï¼š</strong>å¦‚æœæœªè¾¾åˆ°è¦æ±‚åˆ†æ•°ï¼Œä¼šæ‰£åˆ†ï¼ˆæœ€å¤šæ‰£100åˆ†ï¼‰</p>
                <ul>
                    <li><strong>é»„é‡‘ï¼š</strong>ç®€å•30åˆ†/æ™®é€š50åˆ†/å›°éš¾70åˆ†</li>
                    <li><strong>é“‚é‡‘ï¼š</strong>ç®€å•40åˆ†/æ™®é€š70åˆ†/å›°éš¾100åˆ†</li>
                    <li><strong>é’»çŸ³ï¼š</strong>ç®€å•50åˆ†/æ™®é€š90åˆ†/å›°éš¾130åˆ†</li>
                    <li><strong>ç‹è€…ï¼š</strong>åªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼è·å¾—æ®µä½åˆ†ï¼Œè‡³å°‘150åˆ†ï¼ˆæœªè¾¾åˆ°ä¼šæ‰£åˆ†ï¼‰</li>
                </ul>
                
                <p><strong>æ‰£åˆ†è®¡ç®—ï¼š</strong>æ ¹æ®åˆ†æ•°å·®è·è®¡ç®—ï¼Œå¾—åˆ†è¶Šä½æ‰£åˆ†è¶Šå¤šï¼Œæœ€å¤šæ‰£100åˆ†æ®µä½åˆ†</p>
            </div>

            <div class="rank-help-section">
                <h3>ç‰¹æ®Šè§„åˆ™</h3>
                <ul>
                    <li>ç‹è€…æ®µä½åªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼è·å¾—æ®µä½åˆ†</li>
                    <li>æœªè¾¾åˆ°æœ€ä½åˆ†æ•°è¦æ±‚æ—¶ï¼Œä¼šæ ¹æ®å¾—åˆ†æ‰£åˆ†</li>
                    <li>æ®µä½åˆ†ä¸ä¼šä½äº0ï¼ˆæœ‰ä¿æŠ¤æœºåˆ¶ï¼‰</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <h2>æ¸¸æˆç»“æŸï¼</h2>
        <p>ä½ çš„å¾—åˆ†: <span id="finalScore">0</span></p>
        <div class="rank-change" id="rankChange"></div>
        <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.8;">ç‚¹å‡»é‡æ–°å¼€å§‹æŒ‰é’®æˆ–æŒ‰ä»»æ„æ–¹å‘é”®é‡æ–°å¼€å§‹</p>
        <div class="button-group">
            <button onclick="prepareRestart()">é‡æ–°å¼€å§‹</button>
            <button class="secondary" onclick="returnToMainMenu()">è¿”å›ä¸»ç•Œé¢</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const currentRankElement = document.getElementById('currentRank');
        const rankPointsElement = document.getElementById('rankPoints');
        const rankProgressElement = document.getElementById('rankProgress');
        const rankChangeElement = document.getElementById('rankChange');
        const rankHintElement = document.getElementById('rankHint');
        const rankHelpBtn = document.getElementById('rankHelpBtn');
        const rankHelpModal = document.getElementById('rankHelpModal');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const currentDifficultyDisplay = document.getElementById('currentDifficultyDisplay');
        const virtualControls = document.getElementById('virtualControls');

        // æ¸¸æˆè®¾ç½®
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        // éš¾åº¦é…ç½®
        const difficultyConfig = {
            easy: {
                initialLength: 1,
                speed: 200,
                multiplier: 0.5,
                name: 'ç®€å•'
            },
            normal: {
                initialLength: 5,
                speed: 150,
                multiplier: 1.0,
                name: 'æ™®é€š'
            },
            hard: {
                initialLength: 10,
                speed: 100,
                multiplier: 1.5,
                name: 'å›°éš¾'
            }
        };

        // æ®µä½é…ç½®
        const rankConfig = {
            bronze: { name: 'é’é“œ', min: 0, max: 100, segments: 5, color: '#CD7F32' },
            silver: { name: 'ç™½é“¶', min: 101, max: 300, segments: 5, color: '#C0C0C0' },
            gold: { name: 'é»„é‡‘', min: 301, max: 500, segments: 5, color: '#FFD700' },
            platinum: { name: 'é“‚é‡‘', min: 501, max: 800, segments: 5, color: '#E5E4E2' },
            diamond: { name: 'é’»çŸ³', min: 801, max: 1200, segments: 5, color: '#B9F2FF' },
            king: { name: 'ç‹è€…', min: 1201, max: Infinity, segments: Infinity, color: '#FF6B6B' }
        };

        let snake = [];
        let food = {};
        let dx = 0;
        let dy = 0;
        let nextDx = 0;  // ä¸‹ä¸€ä¸ªæ–¹å‘ï¼ˆç”¨äºé˜²æ­¢å¿«é€ŸæŒ‰é”®ï¼‰
        let nextDy = 0;
        let score = 0;
        let highScore = parseInt(localStorage.getItem('snakeHighScore') || 0);
        let gameRunning = false;
        let gamePaused = false;
        let currentDifficulty = 'normal';
        let gameSpeed = 150;
        let rankPoints = parseInt(localStorage.getItem('rankPoints') || 0);
        let previousRank = null;
        let canRestartWithKey = false; // æ˜¯å¦å…è®¸é€šè¿‡æ–¹å‘é”®é‡æ–°å¼€å§‹
        let canChangeDirection = true; // æ˜¯å¦å¯ä»¥æ”¹å˜æ–¹å‘ï¼ˆé˜²æ­¢å¿«é€ŸæŒ‰é”®ï¼‰

        // æ˜¾ç¤ºæœ€é«˜åˆ†å’Œæ®µä½
        highScoreElement.textContent = highScore;
        updateRankDisplay();

        // é€‰æ‹©éš¾åº¦
        function selectDifficulty(difficulty) {
            // æ¸¸æˆè¿›è¡Œä¸­ä¸èƒ½åˆ‡æ¢éš¾åº¦ï¼ˆä½†æ¸¸æˆç»“æŸåå¯ä»¥åˆ‡æ¢ï¼‰
            // åªæœ‰å½“æ¸¸æˆæ­£åœ¨è¿è¡Œä¸”è›‡åœ¨ç§»åŠ¨æ—¶æ‰é˜»æ­¢åˆ‡æ¢
            if (gameRunning && (dx !== 0 || dy !== 0)) {
                return;
            }
            
            currentDifficulty = difficulty;
            const config = difficultyConfig[difficulty];
            gameSpeed = config.speed;
            
            // æ›´æ–°éš¾åº¦æ˜¾ç¤º
            currentDifficultyDisplay.textContent = config.name;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('active');
            
            // é‡æ–°åˆå§‹åŒ–è›‡å’Œæ¸¸æˆçŠ¶æ€
            initSnake();
            dx = 0;
            dy = 0;
            nextDx = 0;
            nextDy = 0;
            score = 0;
            scoreElement.textContent = 0;
            gameRunning = false; // ç¡®ä¿æ¸¸æˆçŠ¶æ€ä¸ºæœªè¿è¡Œ
            gamePaused = false;
            canChangeDirection = true;
            gameOverElement.classList.remove('show'); // éšè—æ¸¸æˆç»“æŸå¼¹çª—
            rankChangeElement.innerHTML = ''; // æ¸…ç©ºæ®µä½å˜åŒ–ä¿¡æ¯
            pauseOverlay.style.display = 'none';
            generateFood();
            drawGame();
        }

        // åˆå§‹åŒ–è›‡ï¼ˆåªåˆ›å»ºèµ·å§‹ç‚¹ï¼Œä¸ç”Ÿæˆèº«ä½“ï¼‰
        function initSnake() {
            snake = [];
            const startX = 10;
            const startY = 10;
            // åªåˆ›å»ºä¸€ä¸ªèµ·å§‹ç‚¹
            snake.push({x: startX, y: startY});
        }

        // æ ¹æ®æ–¹å‘é”®åˆ›å»ºè›‡çš„èº«ä½“
        function createSnakeFromDirection(dx, dy) {
            const config = difficultyConfig[currentDifficulty];
            const startX = 10;
            const startY = 10;
            
            // æ¸…ç©ºè›‡ï¼Œé‡æ–°åˆ›å»º
            snake = [];
            
            // æ ¹æ®éš¾åº¦å’Œæ–¹å‘åˆ›å»ºè›‡çš„èº«ä½“
            // èº«ä½“ä»å¤´éƒ¨å‘ç›¸åæ–¹å‘å»¶ä¼¸
            for (let i = 0; i < config.initialLength; i++) {
                snake.push({
                    x: startX - (dx * i),
                    y: startY - (dy * i)
                });
            }
        }

        // è®¡ç®—æ®µä½
        function calculateRank(points) {
            if (points >= rankConfig.king.min) {
                // ç‹è€…ï¼šæ¯50åˆ†ä¸ºä¸€é¢—æ˜Ÿ
                const stars = Math.floor((points - rankConfig.king.min) / 50) + 1;
                return {
                    rank: 'king',
                    display: `ç‹è€…${stars}æ˜Ÿ`,
                    points: points,
                    progress: 0
                };
            }
            
            for (let rankKey in rankConfig) {
                const rank = rankConfig[rankKey];
                if (rankKey === 'king') continue;
                
                // æ³¨æ„ï¼šé’é“œçš„minæ˜¯0ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                if (rankKey === 'bronze') {
                    if (points >= rank.min && points <= rank.max) {
                        const segmentSize = (rank.max - rank.min) / rank.segments;
                        const currentSegment = Math.floor((points - rank.min) / segmentSize);
                        const segmentPoints = points - rank.min - (currentSegment * segmentSize);
                        const segmentProgress = (segmentPoints / segmentSize) * 100;
                        const segmentNumber = rank.segments - currentSegment;
                        
                        return {
                            rank: rankKey,
                            display: `${rank.name}${segmentNumber}`,
                            points: points,
                            progress: segmentProgress,
                            segmentNumber: segmentNumber
                        };
                    }
                } else {
                    if (points >= rank.min && points <= rank.max) {
                        const segmentSize = (rank.max - rank.min) / rank.segments;
                        const currentSegment = Math.floor((points - rank.min) / segmentSize);
                        const segmentPoints = points - rank.min - (currentSegment * segmentSize);
                        const segmentProgress = (segmentPoints / segmentSize) * 100;
                        // æ®µä½å·ä»5åˆ°1ï¼Œ5æ˜¯æœ€ä½ï¼Œ1æ˜¯æœ€é«˜
                        const segmentNumber = rank.segments - currentSegment;
                        
                        return {
                            rank: rankKey,
                            display: `${rank.name}${segmentNumber}`,
                            points: points,
                            progress: segmentProgress,
                            segmentNumber: segmentNumber
                        };
                    }
                }
            }
            
            return {
                rank: 'bronze',
                display: 'é’é“œ5',
                points: 0,
                progress: 0
            };
        }

        // è®¡ç®—æ®µä½åˆ†ï¼ˆæ ¹æ®éš¾åº¦å’Œå¾—åˆ†ï¼‰
        function calculateRankPoints(gameScore, difficulty) {
            const config = difficultyConfig[difficulty];
            const currentRankInfo = calculateRank(rankPoints);
            
            // ç‹è€…ä»¥ååªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼åŠ åˆ†
            if (currentRankInfo.rank === 'king' && difficulty !== 'hard') {
                return 0; // ç‹è€…ä»¥ååªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼åŠ åˆ†
            }
            
            // è®¾ç½®æœ€ä½åˆ†æ•°è¦æ±‚ï¼ˆä¸åŒéš¾åº¦ä¸åŒè¦æ±‚ï¼‰
            const minScoreRequirement = {
                easy: 20,    // ç®€å•æ¨¡å¼è‡³å°‘20åˆ†
                normal: 30,  // æ™®é€šæ¨¡å¼è‡³å°‘30åˆ†
                hard: 40     // å›°éš¾æ¨¡å¼è‡³å°‘40åˆ†
            };
            
            // ä½æ®µä½ï¼ˆé’é“œã€ç™½é“¶ï¼‰ï¼šå¦‚æœæœªè¾¾åˆ°æœ€ä½åˆ†æ•°è¦æ±‚ï¼Œä¸åŠ åˆ†ä¹Ÿä¸æ‰£åˆ†
            if (currentRankInfo.rank === 'bronze' || currentRankInfo.rank === 'silver') {
                if (gameScore < minScoreRequirement[difficulty]) {
                    return 0; // ä½æ®µä½æœªè¾¾åˆ°æœ€ä½è¦æ±‚ï¼Œä¸åŠ åˆ†ä¹Ÿä¸æ‰£åˆ†
                }
            }
            
            // é»„é‡‘ä»¥ä¸Šæ®µä½çš„æ‰£åˆ†æœºåˆ¶
            if (currentRankInfo.rank === 'gold' || 
                currentRankInfo.rank === 'platinum' || 
                currentRankInfo.rank === 'diamond' || 
                currentRankInfo.rank === 'king') {
                
                // è®¾ç½®ä¸åŒæ®µä½çš„æœ€ä½åˆ†æ•°è¦æ±‚ï¼ˆæœªè¾¾åˆ°ä¼šæ‰£åˆ†ï¼‰
                const rankMinScore = {
                    gold: { easy: 30, normal: 50, hard: 70 },
                    platinum: { easy: 40, normal: 70, hard: 100 },
                    diamond: { easy: 50, normal: 90, hard: 130 },
                    king: { easy: 0, normal: 0, hard: 150 } // ç‹è€…åªèƒ½å›°éš¾æ¨¡å¼ï¼Œè‡³å°‘150åˆ†
                };
                
                const requiredScore = rankMinScore[currentRankInfo.rank][difficulty];
                
                // å¦‚æœæœªè¾¾åˆ°è¦æ±‚åˆ†æ•°ï¼Œæ‰£åˆ†
                if (gameScore < requiredScore) {
                    // æ‰£åˆ†ï¼šæ ¹æ®å·®è·è®¡ç®—ï¼Œæœ€å¤šæ‰£100åˆ†
                    const scoreGap = requiredScore - gameScore;
                    const penalty = Math.min(100, Math.floor(scoreGap * 2));
                    return -penalty; // è¿”å›è´Ÿæ•°è¡¨ç¤ºæ‰£åˆ†
                }
                
                // é»„é‡‘ä»¥ä¸Šæ®µä½ï¼šå¦‚æœæœªè¾¾åˆ°åŸºç¡€æœ€ä½åˆ†æ•°è¦æ±‚ï¼Œä¹Ÿä¼šæ‰£åˆ†
                if (gameScore < minScoreRequirement[difficulty]) {
                    // æ ¹æ®å¾—åˆ†è®¡ç®—æ‰£åˆ†ï¼Œå¾—åˆ†è¶Šä½æ‰£åˆ†è¶Šå¤š
                    const scoreGap = minScoreRequirement[difficulty] - gameScore;
                    // æ‰£åˆ†è®¡ç®—ï¼šæ ¹æ®å·®è·ï¼Œæœ€å¤šæ‰£100åˆ†
                    const penalty = Math.min(100, Math.floor(scoreGap * 2));
                    return -penalty; // è¿”å›è´Ÿæ•°è¡¨ç¤ºæ‰£åˆ†
                }
            }
            
            // è®¡ç®—åŸºç¡€åŠ åˆ†ï¼šå¾—åˆ†è¶Šå¤šåŠ åˆ†è¶Šé«˜
            // ä½¿ç”¨éš¾åº¦å€ç‡ï¼Œå¾—åˆ†è¶Šé«˜åŠ åˆ†è¶Šå¤š
            let basePoints = Math.floor(gameScore * config.multiplier * 0.15);
            
            // ç¡®ä¿æœ‰æœ€ä½åŠ åˆ†ï¼ˆè‡³å°‘1åˆ†ï¼‰
            basePoints = Math.max(1, basePoints);
            
            // å•å±€åŠ åˆ†ä¸Šé™ä¸º50
            basePoints = Math.min(50, basePoints);
            
            return basePoints;
        }

        // æ›´æ–°æ®µä½æ˜¾ç¤º
        function updateRankDisplay() {
            const rankInfo = calculateRank(rankPoints);
            currentRankElement.textContent = rankInfo.display;
            rankPointsElement.textContent = rankPoints;
            rankProgressElement.style.width = rankInfo.progress + '%';
            
            // æ ¹æ®æ®µä½è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            const rankColor = rankConfig[rankInfo.rank].color;
            rankProgressElement.style.background = rankColor;
            
            // æ˜¾ç¤ºæ®µä½æç¤º
            if (rankInfo.rank === 'king') {
                rankHintElement.textContent = 'ç‹è€…æ®µä½åªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼è·å¾—æ®µä½åˆ†';
            } else {
                const nextRank = getNextRank(rankInfo);
                if (nextRank) {
                    const pointsNeeded = nextRank.min - rankPoints;
                    rankHintElement.textContent = `è·ç¦»${nextRank.name}è¿˜éœ€ ${pointsNeeded} åˆ†`;
                } else {
                    rankHintElement.textContent = 'ç»§ç»­åŠªåŠ›ï¼Œå‘ç‹è€…è¿›å‘ï¼';
                }
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('rankPoints', rankPoints);
        }

        // è·å–ä¸‹ä¸€ä¸ªæ®µä½
        function getNextRank(currentRankInfo) {
            const rankOrder = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'king'];
            const currentIndex = rankOrder.indexOf(currentRankInfo.rank);
            
            if (currentIndex < rankOrder.length - 1) {
                const nextRankKey = rankOrder[currentIndex + 1];
                return rankConfig[nextRankKey];
            }
            
            return null;
        }

        // ç”Ÿæˆé£Ÿç‰©ä½ç½®
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            // ç¡®ä¿é£Ÿç‰©ä¸åœ¨è›‡èº«ä¸Š
            for (let segment of snake) {
                if (segment.x === food.x && segment.y === food.y) {
                    generateFood();
                    return;
                }
            }
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            clearCanvas();
            drawSnake();
            drawFood();
            drawScore();
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ç»˜åˆ¶è›‡
        function drawSnake() {
            ctx.fillStyle = '#4CAF50';
            for (let segment of snake) {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            }
            // è›‡å¤´ç”¨ä¸åŒé¢œè‰²
            ctx.fillStyle = '#66BB6A';
            ctx.fillRect(snake[0].x * gridSize, snake[0].y * gridSize, gridSize - 2, gridSize - 2);
        }

        // ç»˜åˆ¶é£Ÿç‰©
        function drawFood() {
            ctx.fillStyle = '#FF5252';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
        }

        // ç»˜åˆ¶åˆ†æ•°
        function drawScore() {
            scoreElement.textContent = score;
        }

        // ç§»åŠ¨è›‡
        function moveSnake() {
            // åº”ç”¨ä¸‹ä¸€ä¸ªæ–¹å‘ï¼ˆé˜²æ­¢å¿«é€ŸæŒ‰é”®ï¼‰
            if (nextDx !== 0 || nextDy !== 0) {
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¹å˜æ–¹å‘ï¼ˆä¸èƒ½ç›´æ¥åå‘ï¼‰
                const goingUp = dy === -1;
                const goingDown = dy === 1;
                const goingRight = dx === 1;
                const goingLeft = dx === -1;
                
                const newGoingUp = nextDy === -1;
                const newGoingDown = nextDy === 1;
                const newGoingRight = nextDx === 1;
                const newGoingLeft = nextDx === -1;
                
                // åªæœ‰åœ¨ä¸æ˜¯ç›´æ¥åå‘çš„æƒ…å†µä¸‹æ‰æ”¹å˜æ–¹å‘
                if (!((goingRight && newGoingLeft) || (goingLeft && newGoingRight) || 
                      (goingUp && newGoingDown) || (goingDown && newGoingUp))) {
                    dx = nextDx;
                    dy = nextDy;
                }
                nextDx = 0;
                nextDy = 0;
            }
            
            // å¦‚æœè›‡æ²¡æœ‰ç§»åŠ¨æ–¹å‘ï¼Œä¸æ‰§è¡Œç§»åŠ¨
            if (dx === 0 && dy === 0) {
                return;
            }
            
            // å…è®¸ä¸‹æ¬¡æ”¹å˜æ–¹å‘
            canChangeDirection = true;

            const head = {x: snake[0].x + dx, y: snake[0].y + dy};

            // æ£€æŸ¥å¢™å£ç¢°æ’
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver();
                return;
            }

            // æ£€æŸ¥è‡ªèº«ç¢°æ’
            // å…ˆæ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©ï¼Œä»¥ä¾¿å†³å®šæ˜¯å¦æ£€æŸ¥æœ€åä¸€ä¸ªæ®µ
            const willEatFood = head.x === food.x && head.y === food.y;
            
            // å¦‚æœåƒåˆ°é£Ÿç‰©ï¼Œéœ€è¦æ£€æŸ¥æ‰€æœ‰æ®µï¼ˆåŒ…æ‹¬æœ€åä¸€ä¸ªæ®µï¼‰
            // å¦‚æœæ²¡åƒåˆ°é£Ÿç‰©ï¼Œæ’é™¤æœ€åä¸€ä¸ªæ®µï¼ˆå› ä¸ºå®ƒä¼šè¢«ç§»é™¤ï¼‰
            const checkLength = willEatFood ? snake.length : snake.length - 1;
            
            for (let i = 0; i < checkLength; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }

            snake.unshift(head);

            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (willEatFood) {
                score += 10;
                generateFood();
                if (score > highScore) {
                    highScore = score;
                    highScoreElement.textContent = highScore;
                    localStorage.setItem('snakeHighScore', highScore);
                }
            } else {
                snake.pop();
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            
            // ä¿å­˜æ¸¸æˆå¼€å§‹å‰çš„æ®µä½
            previousRank = calculateRank(rankPoints);
            
            // è®¡ç®—æ®µä½åˆ†ï¼ˆå¯èƒ½æ˜¯æ­£æ•°åŠ åˆ†ï¼Œè´Ÿæ•°æ‰£åˆ†ï¼Œæˆ–0ï¼‰
            const earnedPoints = calculateRankPoints(score, currentDifficulty);
            
            if (earnedPoints > 0) {
                // åŠ åˆ†
                rankPoints += earnedPoints;
                updateRankDisplay();
                
                // æ˜¾ç¤ºæ®µä½å˜åŒ–
                const newRank = calculateRank(rankPoints);
                const config = difficultyConfig[currentDifficulty];
                const calculatedPoints = Math.floor(score * config.multiplier * 0.15);
                const actualPoints = Math.min(50, Math.max(1, calculatedPoints));
                
                let rankChangeText = `<div style="font-size: 1.1em; margin-bottom: 10px;">
                    <strong>è·å¾—æ®µä½åˆ†: <span style="color: #4CAF50; font-weight: bold; font-size: 1.2em;">+${earnedPoints}</span></strong>
                </div>`;
                rankChangeText += `<div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    è®¡ç®—æ–¹å¼: ${score}åˆ† Ã— ${config.multiplier}å€ç‡ Ã— 0.15 = ${calculatedPoints}åˆ†<br>
                    å®é™…è·å¾—: ${actualPoints}åˆ†ï¼ˆå•å±€ä¸Šé™50åˆ†ï¼‰
                </div>`;
                
                // æ£€æŸ¥æ˜¯å¦å‡æ®µ
                if (previousRank.rank !== newRank.rank) {
                    rankChangeText += `<div style="margin-top: 10px;"><span class="rank-up">ğŸ‰ æ­å–œå‡æ®µï¼${previousRank.display} â†’ ${newRank.display}</span></div>`;
                } else if (previousRank.display !== newRank.display) {
                    rankChangeText += `<div style="margin-top: 10px;"><span class="rank-up">ğŸ‰ æ­å–œå‡æ®µï¼${previousRank.display} â†’ ${newRank.display}</span></div>`;
                }
                
                rankChangeElement.innerHTML = rankChangeText;
            } else if (earnedPoints < 0) {
                // æ‰£åˆ†
                const penalty = Math.abs(earnedPoints);
                rankPoints = Math.max(0, rankPoints - penalty); // ç¡®ä¿æ®µä½åˆ†ä¸ä¸ºè´Ÿæ•°
                updateRankDisplay();
                
                // æ˜¾ç¤ºæ®µä½å˜åŒ–
                const newRank = calculateRank(rankPoints);
                const currentRankInfo = calculateRank(rankPoints + penalty); // æ‰£åˆ†å‰çš„æ®µä½
                
                // åˆ¤æ–­æ‰£åˆ†åŸå› 
                const minScoreRequirement = {
                    easy: 20,
                    normal: 30,
                    hard: 40
                };
                let reasonText = '';
                if (score < minScoreRequirement[currentDifficulty]) {
                    reasonText = `æœªè¾¾åˆ°æœ€ä½åˆ†æ•°è¦æ±‚ï¼ˆ${minScoreRequirement[currentDifficulty]}åˆ†ï¼‰`;
                } else if (currentRankInfo.rank === 'gold' || currentRankInfo.rank === 'platinum' || 
                          currentRankInfo.rank === 'diamond' || currentRankInfo.rank === 'king') {
                    const rankMinScore = {
                        gold: { easy: 30, normal: 50, hard: 70 },
                        platinum: { easy: 40, normal: 70, hard: 100 },
                        diamond: { easy: 50, normal: 90, hard: 130 },
                        king: { easy: 0, normal: 0, hard: 150 }
                    };
                    const requiredScore = rankMinScore[currentRankInfo.rank][currentDifficulty];
                    if (score < requiredScore) {
                        reasonText = `æœªè¾¾åˆ°${currentRankInfo.display}æ®µä½è¦æ±‚åˆ†æ•°ï¼ˆ${requiredScore}åˆ†ï¼‰`;
                    }
                }
                
                let rankChangeText = `<div style="font-size: 1.1em; margin-bottom: 10px;">
                    <strong>æ‰£é™¤æ®µä½åˆ†: <span style="color: #f44336; font-weight: bold; font-size: 1.2em;">-${penalty}</span></strong>
                </div>`;
                if (reasonText) {
                    rankChangeText += `<div style="font-size: 0.9em; color: #ff9800; margin-bottom: 10px;">
                        æ‰£åˆ†åŸå› : ${reasonText}
                    </div>`;
                }
                
                // æ£€æŸ¥æ˜¯å¦é™æ®µ
                if (previousRank.rank !== newRank.rank) {
                    rankChangeText += `<div style="margin-top: 10px;"><span style="color: #f44336;">âš ï¸ é™æ®µäº†ï¼${previousRank.display} â†’ ${newRank.display}</span></div>`;
                } else if (previousRank.display !== newRank.display) {
                    rankChangeText += `<div style="margin-top: 10px;"><span style="color: #f44336;">âš ï¸ é™æ®µäº†ï¼${previousRank.display} â†’ ${newRank.display}</span></div>`;
                } else {
                    rankChangeText += `<div style="margin-top: 10px;"><span style="color: #ff9800;">åˆ†æ•°æœªè¾¾åˆ°è¦æ±‚ï¼Œç»§ç»­åŠªåŠ›ï¼</span></div>`;
                }
                
                rankChangeElement.innerHTML = rankChangeText;
            } else {
                // æœªè·å¾—æ®µä½åˆ†ï¼ˆè¿™ç§æƒ…å†µç°åœ¨åº”è¯¥å¾ˆå°‘ï¼Œå› ä¸ºæœªè¾¾åˆ°æœ€ä½è¦æ±‚ä¼šæ‰£åˆ†ï¼‰
                if (previousRank.rank === 'king' && currentDifficulty !== 'hard') {
                    rankChangeElement.innerHTML = 'ç‹è€…æ®µä½åªèƒ½é€šè¿‡å›°éš¾æ¨¡å¼è·å¾—æ®µä½åˆ†';
                } else {
                    rankChangeElement.innerHTML = 'æœªè·å¾—æ®µä½åˆ†';
                }
            }
            
            gameOverElement.classList.add('show');
        }

        // å‡†å¤‡é‡æ–°å¼€å§‹ï¼ˆç‚¹å‡»æŒ‰é’®åï¼Œå…è®¸é€šè¿‡æ–¹å‘é”®é‡æ–°å¼€å§‹ï¼Œæˆ–ç›´æ¥å¼€å§‹æ¸¸æˆï¼‰
        function prepareRestart() {
            canRestartWithKey = true;
            // ç›´æ¥å¼€å§‹æ¸¸æˆï¼Œé»˜è®¤å‘å³ç§»åŠ¨
            restartGame(1, 0);
        }

        // è¿”å›ä¸»ç•Œé¢
        function returnToMainMenu() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            initSnake();
            dx = 0;
            dy = 0;
            nextDx = 0;
            nextDy = 0;
            score = 0;
            scoreElement.textContent = 0;
            gameRunning = false;
            gamePaused = false;
            canChangeDirection = true;
            canRestartWithKey = false;
            
            // éšè—æ¸¸æˆç»“æŸå¼¹çª—å’Œæš‚åœæç¤º
            gameOverElement.classList.remove('show');
            rankChangeElement.innerHTML = '';
            pauseOverlay.style.display = 'none';
            
            // é‡æ–°ç”Ÿæˆé£Ÿç‰©å¹¶ç»˜åˆ¶
            generateFood();
            drawGame();
        }

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            if (gamePaused) {
                pauseOverlay.style.display = 'flex';
            } else {
                pauseOverlay.style.display = 'none';
                lastFrameTime = performance.now(); // é‡ç½®æ—¶é—´ï¼Œé¿å…æš‚åœåç«‹å³ç§»åŠ¨
                requestAnimationFrame(gameLoop);
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame(initialDx = 0, initialDy = 0) {
            // å…ˆè®¾ç½®æ–¹å‘
            dx = initialDx;
            dy = initialDy;
            nextDx = 0;
            nextDy = 0;
            
            // æ ¹æ®æ–¹å‘åˆ›å»ºè›‡çš„èº«ä½“
            if (dx !== 0 || dy !== 0) {
                createSnakeFromDirection(dx, dy);
            } else {
                // å¦‚æœæ²¡æœ‰æ–¹å‘ï¼Œåªåˆ›å»ºèµ·å§‹ç‚¹
                initSnake();
            }
            
            score = 0;
            gameRunning = true;
            gamePaused = false;
            canChangeDirection = true;
            canRestartWithKey = false; // æ¸¸æˆå¼€å§‹åï¼Œé‡ç½®çŠ¶æ€
            gameOverElement.classList.remove('show');
            rankChangeElement.innerHTML = '';
            pauseOverlay.style.display = 'none';
            lastFrameTime = performance.now();
            generateFood();
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // æ¸¸æˆä¸»å¾ªç¯ï¼ˆä½¿ç”¨requestAnimationFrameï¼‰
        let lastFrameTime = 0;
        function gameLoop(currentTime) {
            if (gameRunning && !gamePaused) {
                // æ§åˆ¶æ¸¸æˆé€Ÿåº¦
                if (currentTime - lastFrameTime >= gameSpeed) {
                    moveSnake();
                    drawGame();
                    lastFrameTime = currentTime;
                }
                requestAnimationFrame(gameLoop);
            }
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            const LEFT_KEY = 37;
            const RIGHT_KEY = 39;
            const UP_KEY = 38;
            const DOWN_KEY = 40;

            const W_KEY = 87;
            const A_KEY = 65;
            const S_KEY = 83;
            const D_KEY = 68;

            const keyPressed = e.keyCode;

            // å¦‚æœæ¸¸æˆæœªè¿è¡Œï¼ŒæŒ‰æ–¹å‘é”®å¼€å§‹/é‡æ–°å¼€å§‹æ¸¸æˆ
            if (!gameRunning) {
                // ç›´æ¥æŒ‰æ–¹å‘é”®é‡æ–°å¼€å§‹ï¼ˆæ— è®ºæ˜¯ç¬¬ä¸€æ¬¡å¼€å§‹è¿˜æ˜¯æ¸¸æˆç»“æŸåï¼‰
                if (keyPressed === LEFT_KEY || keyPressed === A_KEY) {
                    restartGame(-1, 0);
                } else if (keyPressed === UP_KEY || keyPressed === W_KEY) {
                    restartGame(0, -1);
                } else if (keyPressed === RIGHT_KEY || keyPressed === D_KEY) {
                    restartGame(1, 0);
                } else if (keyPressed === DOWN_KEY || keyPressed === S_KEY) {
                    restartGame(0, 1);
                }
                return;
            }

            // æš‚åœåŠŸèƒ½ï¼ˆæŒ‰ç©ºæ ¼é”®ï¼‰
            if (keyPressed === 32) { // ç©ºæ ¼é”®
                if (gameRunning) {
                    togglePause();
                }
                return;
            }

            // æ¸¸æˆè¿è¡Œä¸­çš„æ§åˆ¶ï¼ˆä½¿ç”¨nextDx/nextDyé˜²æ­¢å¿«é€ŸæŒ‰é”®ï¼‰
            if (gameRunning && !gamePaused && canChangeDirection) {
                const goingUp = dy === -1;
                const goingDown = dy === 1;
                const goingRight = dx === 1;
                const goingLeft = dx === -1;

                if ((keyPressed === LEFT_KEY || keyPressed === A_KEY) && !goingRight) {
                    nextDx = -1;
                    nextDy = 0;
                    canChangeDirection = false; // é”å®šæ–¹å‘æ”¹å˜ï¼Œç›´åˆ°ä¸‹æ¬¡ç§»åŠ¨
                }
                if ((keyPressed === UP_KEY || keyPressed === W_KEY) && !goingDown) {
                    nextDx = 0;
                    nextDy = -1;
                    canChangeDirection = false;
                }
                if ((keyPressed === RIGHT_KEY || keyPressed === D_KEY) && !goingLeft) {
                    nextDx = 1;
                    nextDy = 0;
                    canChangeDirection = false;
                }
                if ((keyPressed === DOWN_KEY || keyPressed === S_KEY) && !goingUp) {
                    nextDx = 0;
                    nextDy = 1;
                    canChangeDirection = false;
                }
            }
        });

        // ç»‘å®šéš¾åº¦é€‰æ‹©æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const difficulty = this.getAttribute('data-difficulty');
                selectDifficulty(difficulty);
            });
        });

        // è™šæ‹Ÿæ–¹å‘é”®äº‹ä»¶å¤„ç†
        document.querySelectorAll('.virtual-btn[data-direction]').forEach(btn => {
            btn.addEventListener('click', function() {
                const direction = this.getAttribute('data-direction');
                handleDirectionInput(direction);
            });
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            btn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const direction = this.getAttribute('data-direction');
                handleDirectionInput(direction);
            });
        });

        // å¤„ç†æ–¹å‘è¾“å…¥ï¼ˆç»Ÿä¸€å¤„ç†é”®ç›˜å’Œè™šæ‹ŸæŒ‰é”®ï¼‰
        function handleDirectionInput(direction) {
            if (!gameRunning) {
                // å¦‚æœæ¸¸æˆæœªè¿è¡Œï¼ŒæŒ‰æ–¹å‘é”®å¼€å§‹/é‡æ–°å¼€å§‹æ¸¸æˆ
                if (direction === 'left') {
                    restartGame(-1, 0);
                } else if (direction === 'up') {
                    restartGame(0, -1);
                } else if (direction === 'right') {
                    restartGame(1, 0);
                } else if (direction === 'down') {
                    restartGame(0, 1);
                }
                return;
            }
            
            if (gamePaused) {
                return; // æš‚åœæ—¶ä¸å…è®¸æ”¹å˜æ–¹å‘
            }

            // æ¸¸æˆè¿è¡Œä¸­çš„æ§åˆ¶
            if (canChangeDirection) {
                const goingUp = dy === -1;
                const goingDown = dy === 1;
                const goingRight = dx === 1;
                const goingLeft = dx === -1;

                if (direction === 'left' && !goingRight) {
                    nextDx = -1;
                    nextDy = 0;
                    canChangeDirection = false;
                } else if (direction === 'up' && !goingDown) {
                    nextDx = 0;
                    nextDy = -1;
                    canChangeDirection = false;
                } else if (direction === 'right' && !goingLeft) {
                    nextDx = 1;
                    nextDy = 0;
                    canChangeDirection = false;
                } else if (direction === 'down' && !goingUp) {
                    nextDx = 0;
                    nextDy = 1;
                    canChangeDirection = false;
                }
            }
        }

        // åˆå§‹åŒ–éš¾åº¦æ˜¾ç¤º
        currentDifficultyDisplay.textContent = difficultyConfig[currentDifficulty].name;

        // æ¸…é™¤æ•°æ®åŠŸèƒ½
        function clearAllData() {
            // ç¡®è®¤å¯¹è¯æ¡†
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤ï¼š\n- æ®µä½åˆ†\n- æœ€é«˜åˆ†\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…é™¤localStorage
                localStorage.removeItem('rankPoints');
                localStorage.removeItem('snakeHighScore');
                
                // é‡ç½®å˜é‡
                rankPoints = 0;
                highScore = 0;
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                score = 0;
                scoreElement.textContent = 0;
                highScoreElement.textContent = 0;
                
                // æ›´æ–°æ®µä½æ˜¾ç¤º
                updateRankDisplay();
                
                // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                initSnake();
                dx = 0;
                dy = 0;
                gameRunning = false;
                gameOverElement.classList.remove('show');
                rankChangeElement.innerHTML = '';
                generateFood();
                drawGame();
                
                alert('æ•°æ®å·²æ¸…é™¤ï¼');
            }
        }

        // ç»‘å®šæ¸…é™¤æ•°æ®æŒ‰é’®äº‹ä»¶
        document.getElementById('clearDataBtn').addEventListener('click', function() {
            if (!gameRunning) {
                clearAllData();
            } else {
                alert('æ¸¸æˆè¿›è¡Œä¸­æ— æ³•æ¸…é™¤æ•°æ®ï¼Œè¯·å…ˆç»“æŸæ¸¸æˆï¼');
            }
        });

        // å¯¼å‡ºæ•°æ®åŠŸèƒ½
        function exportData() {
            if (gameRunning) {
                alert('æ¸¸æˆè¿›è¡Œä¸­æ— æ³•å¯¼å‡ºæ•°æ®ï¼Œè¯·å…ˆç»“æŸæ¸¸æˆï¼');
                return;
            }

            const data = {
                rankPoints: rankPoints,
                highScore: highScore,
                exportTime: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `snake-game-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // åŒæ—¶å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(dataStr).then(() => {
                    alert('æ•°æ®å·²å¯¼å‡ºå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ–‡ä»¶å·²ä¸‹è½½ï¼ŒåŒæ—¶æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´åˆ†äº«ã€‚');
                }).catch(() => {
                    alert('æ•°æ®å·²å¯¼å‡ºï¼\n\næ–‡ä»¶å·²ä¸‹è½½ã€‚');
                });
            } else {
                alert('æ•°æ®å·²å¯¼å‡ºï¼\n\næ–‡ä»¶å·²ä¸‹è½½ã€‚');
            }
        }

        // å¯¼å…¥æ•°æ®åŠŸèƒ½
        function importData() {
            if (gameRunning) {
                alert('æ¸¸æˆè¿›è¡Œä¸­æ— æ³•å¯¼å…¥æ•°æ®ï¼Œè¯·å…ˆç»“æŸæ¸¸æˆï¼');
                return;
            }

            const fileInput = document.getElementById('importFileInput');
            fileInput.click();
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        document.getElementById('importFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (typeof importedData.rankPoints !== 'number' || 
                        typeof importedData.highScore !== 'number') {
                        throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }

                    // éªŒè¯æ•°æ®èŒƒå›´
                    if (importedData.rankPoints < 0 || importedData.highScore < 0) {
                        throw new Error('æ•°æ®å€¼æ— æ•ˆ');
                    }

                    // ç¡®è®¤å¯¼å…¥
                    const confirmMsg = `ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿ\n\n` +
                        `æ®µä½åˆ†: ${importedData.rankPoints} (å½“å‰: ${rankPoints})\n` +
                        `æœ€é«˜åˆ†: ${importedData.highScore} (å½“å‰: ${highScore})\n\n` +
                        `å¯¼å…¥åå°†è¦†ç›–å½“å‰æ•°æ®ï¼`;
                    
                    if (confirm(confirmMsg)) {
                        // å¯¼å…¥æ•°æ®
                        rankPoints = Math.floor(importedData.rankPoints);
                        highScore = Math.floor(importedData.highScore);

                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem('rankPoints', rankPoints);
                        localStorage.setItem('snakeHighScore', highScore);

                        // æ›´æ–°æ˜¾ç¤º
                        highScoreElement.textContent = highScore;
                        updateRankDisplay();

                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–æ–‡ä»¶å·²æŸåã€‚\n\nè¯·ç¡®ä¿å¯¼å…¥çš„æ˜¯æ­£ç¡®çš„æ¸¸æˆæ•°æ®æ–‡ä»¶ã€‚');
                    console.error('Import error:', error);
                }

                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
                e.target.value = '';
            };

            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                e.target.value = '';
            };

            reader.readAsText(file);
        });

        // ç»‘å®šå¯¼å‡ºæ•°æ®æŒ‰é’®äº‹ä»¶
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            exportData();
        });

        // ç»‘å®šå¯¼å…¥æ•°æ®æŒ‰é’®äº‹ä»¶
        document.getElementById('importDataBtn').addEventListener('click', function() {
            importData();
        });

        // æš´éœ²å‡½æ•°åˆ°windowï¼Œæ–¹ä¾¿è°ƒè¯•
        window.exportData = exportData;
        window.importData = importData;

        // æ‰“å¼€æ®µä½è§„åˆ™è¯´æ˜
        function openRankHelp() {
            rankHelpModal.classList.add('show');
        }

        // å…³é—­æ®µä½è§„åˆ™è¯´æ˜
        function closeRankHelp() {
            rankHelpModal.classList.remove('show');
        }

        // ç»‘å®šæ®µä½è¯´æ˜æŒ‰é’®äº‹ä»¶
        rankHelpBtn.addEventListener('click', openRankHelp);

        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
        rankHelpModal.addEventListener('click', function(e) {
            if (e.target === rankHelpModal) {
                closeRankHelp();
            }
        });

        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 27 && rankHelpModal.classList.contains('show')) {
                closeRankHelp();
            }
        });

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.selectDifficulty = selectDifficulty;
        window.clearAllData = clearAllData;
        window.prepareRestart = prepareRestart;
        window.restartGame = restartGame;
        window.returnToMainMenu = returnToMainMenu;
        window.openRankHelp = openRankHelp;
        window.closeRankHelp = closeRankHelp;

        // åˆå§‹åŒ–æ¸¸æˆ
        initSnake();
        generateFood();
        drawGame();
    </script>
</body>
</html>
